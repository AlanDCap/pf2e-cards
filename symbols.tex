\tikzset{roll box/.style={inner ysep=0.7em, fill=black!20}}
\tikzset{check roll box/.style={roll box, fill=blue!20}}
\tikzset{damage roll box/.style={roll box, fill=red!20, rounded corners=0.5em}}
\tikzset{effect box/.style={roll box, fill=red!20, rounded corners=0.5em}}

\newcommand{\pfsymbol}[1]{%
  \mbox{\pfsymbols\selectfont#1}
}

% TODO fix distance between actions, maybe avoid draw in favor of more fill?
\newcommand{\ActionSymbol}[1]{
  \ifnum\strcmp{#1}{R} = 0
    \pfsymbol{reaction}
  \fi
  \ifnum #1 = 0
    \pfsymbol{free-action}
  \fi
  \ifnum #1 = 1
    \pfsymbol{one-action}
  \fi
  \ifnum #1 = 2
    \pfsymbol{two-actions}
  \fi
  \ifnum #1 = 3
    \pfsymbol{three-actions} 
  \fi           
}

\newcommand{\FormulaVariable}[2]{
  \operatorname{
    \tikz[baseline] \path
      node[draw, shape=rectangle, anchor=base, fill=white] (box) { #2 }
      (box.south) node[below=-0.5ex] {\makebox[0pt][c]{\tiny \engschrift #1}};
    }
  }

\NewDocumentCommand{\CheckFormula}{mo}{
  \(
    \operatorname{1d20} + \FormulaVariable{
      \foreach[count=\index] \summand in {#1}
        {\ifnum \index > 1 ~+~ \fi \summand}
      }{\phantom{100}}\IfValueT{#2}{\ge \operatorname{\mbox{#2}}}%
  \)%
}

\NewDocumentCommand{\CheckRoll}{mmo}{
  \tikz[baseline=(content.base)]{
    \node (content)  {
      \strut\smash{
        \parbox[t]{1.25em}{\CheckType{#1}[]}
        \CheckFormula{#2}[#3]%
      }%
    };
    \begin{pgfonlayer}{background}
      \node [fit=(content), check roll box] (box) {};
    \end{pgfonlayer}%
  }%
}

\NewDocumentCommand{\DamageRoll}{momm}{
  \tikz[baseline=(content.base)]{
    \node (content) {
      \strut\smash{
        \IfValueTF{#2}
          {%
            \raisebox{0.4em}{\DamageType{#1}}%
            \clap{\tikz[baseline] \draw (-0.6em, -0.4em) -- (0.6em, 1.2em);}%
            \raisebox{-0.4em}{\DamageType{#2}}%
          }
          {\DamageType{#1}}
        \(
          \mbox{#3}
          \foreach \part in {#4} {
            + \FormulaVariable{\part}{\phantom{1}}
          }
        \)
      }
    };
    \begin{pgfonlayer}{background}
      \node [fit=(content), damage roll box] (box) {};
    \end{pgfonlayer}
  }
}

% TODO: allow for up to four arguments (crit success, success, failure, crit failure)
% TODO: render degrees of success icons in respective rows
\NewDocumentCommand{\EffectBox}{mm}{
  \tikz[baseline=(content.base)]{
    \node (content) {\strut\smash{
      {\setlength{\tabcolsep}{0pt}\begin{tabular}{l}#1\\#2\end{tabular}}
    }};
    \begin{pgfonlayer}{background}
      \node [fit=(content), effect box] (box) {};
    \end{pgfonlayer}
  }
}

\NewDocumentCommand{\CheckType}{mo}{
  \ifcsname CheckType#1\endcsname
  \csname CheckType#1\endcsname
  \else
  \IfValueTF{#2}{#2}{#1}
  \fi
}

\NewDocumentCommand{\DamageType}{mo}{%
  \ifcsname DamageType#1\endcsname
  \csname DamageType#1\endcsname
  \else
  \IfValueTF{#2}{#2}{#1}
  \fi
}

% Keep this for future reference when importing icons from game-icons.net
\tikzset{game-icons.net/.style={fill,scale=0.002em,yscale=-1}}

\newcommand{\DamageTypeFire}{\pfsymbol{fire}}
\newcommand{\DamageTypeCold}{\pfsymbol{cold}}
\newcommand{\DamageTypeSlashing}{\pfsymbol{slashing}}
\newcommand{\DamageTypeBludgeoning}{\pfsymbol{bludgeoning}}
\newcommand{\DamageTypePiercing}{\pfsymbol{piercing}}
\newcommand{\DamageTypeBleed}{\pfsymbol{bleeding}}
\newcommand{\DamageTypeMental}{\pfsymbol{mental}}
\newcommand{\DamageTypeForce}{\pfsymbol{force}}
\newcommand{\DamageTypeAcid}{\pfsymbol{acid}}
\newcommand{\DamageTypeElectricity}{\pfsymbol{electricity}}
\newcommand{\DamageTypeMagic}{\pfsymbol{magical}}
\newcommand{\DamageTypeSonic}{\pfsymbol{sonic}}
\newcommand{\DamageTypePoison}{\pfsymbol{poison}}
\newcommand{\DamageTypeGood}{\pfsymbol{good}}
\newcommand{\DamageTypeEvil}{\pfsymbol{evil}}
\newcommand{\DamageTypeChaotic}{\pfsymbol{chaotic}}
\newcommand{\DamageTypeLawful}{\pfsymbol{lawful}}
\newcommand{\DamageTypeNegative}{\pfsymbol{negative}}
\newcommand{\DamageTypePositive}{\pfsymbol{positive}}
