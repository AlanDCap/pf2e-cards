\NeedsTeXFormat{LaTeX2e}[2020/10/01]
\ProvidesClass{card-style}
  [2023/08/25 v0.01]

\LoadClass[DIV=21, fontsize=7.5pt]{scrartcl}
\KOMAoptions{paper=63mm:88mm, DIV=21, fontsize=7.5pt}

\RequirePackage{xcolor}
\RequirePackage{fontspec}
\RequirePackage{mathtools}
\RequirePackage{tikz}
\RequirePackage[warnings-off={mathtools-colon,mathtools-overbracket}]{unicode-math}
\RequirePackage{multicol}
\RequirePackage{xparse}
\RequirePackage[implicit=false]{hyperref}
\RequirePackage{bookmark}

\usetikzlibrary{svg.path}
\usetikzlibrary{fit}
\usetikzlibrary{backgrounds}

\input{fonts.tex}

\input{symbols.tex}

\setlength\parindent{0pt} % todo: avoid in favor of some komascript feature
\setlength\parskip{4pt} % todo: avoid in favor of some komascript feature

\addtokomafont{section}{\normalfont\postamt}
\addtokomafont{subsection}{\normalfont\mittelschrift}

% move the card headings higher (into the page border?)
\RedeclareSectionCommand[runin=false, afterindent=false, beforeskip=-2em]{section}

\renewcommand*{\sectionformat}{}
\renewcommand*{\subsectionformat}{}

\newcommand{\Category}[1]{\clearpage\bookmark[page=\thepage, level=0]{#1}}

\newcounter{cards}

\newcommand{\cardStyle@drawCardFrame}[1]{%
  \def\cardStyle@cardColor{}
  \ifnum\pdfstrcmp{#1}{Item}=0      \def\cardStyle@cardColor{blue!40} \fi
  \ifnum\pdfstrcmp{#1}{Action}=0    \def\cardStyle@cardColor{yellow!40} \fi
  \ifnum\pdfstrcmp{#1}{Spell}=0     \def\cardStyle@cardColor{green!40} \fi
  \ifnum\pdfstrcmp{#1}{Cantrip}=0   \def\cardStyle@cardColor{green!40} \fi
  \ifnum\pdfstrcmp{#1}{Focus}=0     \def\cardStyle@cardColor{green!40} \fi
  
  \ifnum\pdfstrcmp{\cardStyle@cardColor}{}=0 \else
    \tikz[remember picture,overlay] {%
      \draw [color=\cardStyle@cardColor,rounded corners=4mm,line width=4mm]
        (current page.north east)
        +(-24mm,0mm) coordinate(a)
        +(0mm, -3mm) coordinate(b)
        
        (current page.north west) 
        {[rounded corners=0mm]--(a)} 
        {[rounded corners=1mm]--(a |- b)}
        {[rounded corners=0mm]--(b)}
        --(current page.south east)  
        --(current page.south west)
        --cycle
        (a) -- (current page.north east);
    }
  \fi
}

\xdef\cardStyle@currentCardCategory{None}
\AddToHook{shipout/background}{\cardStyle@drawCardFrame{\cardStyle@currentCardCategory}}

% \Card{<card-type>}{<level>}{<title>}[<source-book>][<source-page>]
% TODO: make reference mandatory, but we need to define all the references first
\NewDocumentCommand{\Card}{mmmoo}{%
  \clearpage

  % Check that last card fitted on one page
  \pgfmathparse{int(\value{cards})}
  \ifnum\pgfmathresult=0
    \pgfmathparse{int(\value{page})}
    \let\pageOfFirstCard\pgfmathresult
  \else
    \pgfmathparse{int(\value{page} - \pageOfFirstCard - \value{cards})}
    \ifnum\pgfmathresult=0
      % good
    \else
      \ClassWarning{card-style}{Previous card defined in \LastCardFilePath\space needed \pgfmathresult\space pages too much}
      % make sure remaining cards are not warned against, by pretending there were more cards
      \addtocounter{cards}{\pgfmathresult}
    \fi
  \fi
  % store current file in LastCardFilePath, in case it's needed later to produce a better error message
  \xdef\LastCardFilePath{\CurrentFilePath/\CurrentFile}

  \xdef\cardStyle@currentCardCategory{#1}

  \stepcounter{cards}

  \bookmark[page=\thepage, level=1]{#3 \ifnum\pdfstrcmp{#2}{}=0\else (#1 #2)\fi}%
  \raisebox{0pt}[0pt][0pt]{}%
  \hfill\raisebox{1em}[0pt][0pt]{\normalfont\postamt#1 #2}%
  \section{#3 \hfill \IfValueT{#4}{\IfValueT{#5}{\Reference{#4}{#5}}}}%
}

\pagestyle{empty}
